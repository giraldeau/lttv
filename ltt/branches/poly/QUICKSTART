
QUICKSTART

How to use LTTng and LTTV in a few lines :

This document is made of four parts : The first one explains how to install
LTTng and LTTV from Debian and RPM binary packages, the second one explains how
to install LTTng and LTTV from sources and the third one describes the steps
to follow to trace a system and view it. The fourth and last part explains
briefly how to add a new trace point to the kernel and to user space
applications.

What you will typically want is to read sections 2 and 3 : install LTTng from
sources and use it.

These operations are made for installing the LTTng 0.5.X tracer on a
linux 2.6.X kernel. You will also find instructions for installation of
LTTV 0.8.x : the Linux Trace Toolkit Viewer. 

To see the list of compatibilities between LTTng, ltt-control, LTTV, genevent
and ltt-usertrace, please refer to :
http://ltt.polymtl.ca > LTTng+LTTV versions compatibility



The following lttng patch is necessary to have the tracing hooks in the kernel.
The following ltt-control module controls the tracing.

Required programs and librairies are assumed to be automatically installed in an
installation with Debian or RPM packages. In the case of an installation from
sources, the dependencies are listed.


** Current development status **

LTTng : 
supported architectures : 
Intel Pentium (UP/SMP) with TSC
PowerPC 32 and 64 bits
ARM
C2 Microsystems (variant of MIPS)

LTTV :
supported architectures :
Intel i386 and better
Intel 64 bits
PowerPC 32 and 64 bits



Author : Mathieu Desnoyers, September 2005
Last update : May 30, 2006


***********************************************************
** Section 1 * Installation from Debian or RPM packages  **
***********************************************************

** NOTE : RPM and debian packages are only made once a version has been
   thoroughly tested. If they do not exist at the moment, please install from
   sources (see section 2 below). To see the list of compatibilities between
   LTTng, ltt-control, LTTV, genevent and lttng-modules, please refer to
   http://ltt.polymtl.ca > LTTng+LTTV versions compatibility


* Install from RPM packages on Fedora Core 4 :

Get LTTV RPM from :

http://ltt.polymtl.ca/packages/fedora/RPMS

LTTV RPM are ready.

LTTng kernel and lttng-modules RPM are available for some architectures (i586,
i686). Feel free to help fix the spec files to have correct lttng-modules RPM
package.


* Install from Deb packages on Debian :

You can use the ltt.polymtl.ca apt source to get LTTV for Debian :

Add the following two sources to your /etc/apt/sources.list :

deb http://ltt.polymtl.ca/packages/debian experimental main
deb-src http://ltt.polymtl.ca/packages/debian experimental main


* Install from precompiled binary packages (LTTV compiled only for i386, and
  LTTng only for i686 smp), perform the following :

su -
apt-get update
apt-get install lttv lttv-doc
apt-get install kernel-image-2.6.12-rc4-mm2-lttng-0.4.2
apt-get install lttng-modules-modules-2.6.12-rc4-mm2-lttng-0.4.2
  * note : the packages are signed by myself. I am not considered a trusted
    Debian source yet, so warnings are normal.

Then, follow the section "Editing the system wide configuration" in section 2.

* Create custom LTTV Debian packages

Binary packages are only available for i386. If you want to create your own LTTV
packages for other platforms, do :

su -
cd /usr/src
apt-get source lttv
cd lttv-0.6.9
dpkg-buildpackage -rfakeroot

You should then have your LTTV .deb files created for your architecture.

* Create custom LTTng packages

For building LTTng Debian packages :

su -
apt-get install kernel-source-2.6.12-rc4-mm2-lttng-0.4.2
cd /usr/src
bzip2 -cd kernel-source-2.6.12-rc4-mm2-lttng-0.4.2.tar.bz2 | tar xvof -
cd kernel-source-2.6.12-rc4-mm2-lttng-0.4.2
make menuconfig (or xconfig or config) (customize your configuration)
make-kpkg kernel_image

You will then see your freshly created .deb in /usr/src. Install it with
dpkg -i /usr/src/(image-name).deb

You will also need to create a package for the lttng-modules :

su -
cd /usr/src
apt-get source lttng-modules
cd kernel-source-2.6.12-rc4-mm2-lttng-0.4.2
make-kpkg --added_modules /usr/src/lttng-modules-0.3 modules_image

You will then see your freshly created .deb in /usr/src. Install it with
dpkg -i /usr/src/lttng-modules-modules-(your version).deb


Then, follow the section "Editing the system wide configuration" in section 2.


***********************************************************
** Section 2 * Installation from sources                 **
***********************************************************

* Prerequisites

Tools needed to follow the package download steps :

o wget
o bzip2
o gzip
o tar

You have to install the standard development librairies and programs necessary
to compile a kernel :

(from Documentation/Changes in the Linux kernel tree)
o  Gnu C                  2.95.3                  # gcc --version
o  Gnu make               3.79.1                  # make --version
o  binutils               2.12                    # ld -v
o  util-linux             2.10o                   # fdformat --version
o  module-init-tools      0.9.10                  # depmod -V

You might also want to have libncurses5 to have the text mode kernel
configuration menu, but there are alternatives.

Prerequisites for LTTV 0.x.x installation are :

gcc 3.2 or better
gtk 2.4 or better development libraries
  (Debian : libgtk2.0, libgtk2.0-dev)
  (Fedora : gtk2, gtk2-devel)
  note : For Fedora users : this might require at least core 3 from Fedora,
  or you might have to compile your own GTK2 library.
glib 2.4 or better development libraries
  (Debian : libglib2.0-0, libglib2.0-dev)
  (Fedora : glib2, glib2-devel)
libpopt development libraries
  (Debian : libpopt0, libpopt-dev)
  (Fedora : popt)
libpango development libraries
  (Debian : libpango1.0, libpango1.0-dev)
  (Fedora : pango, pango-devel)
libc6 development librairies 
  (Debian : libc6, libc6-dev)
  (Fedora : glibc, glibc)


* Getting the LTTng packages

su -
mkdir /usr/src/lttng
cd /usr/src/lttng
(see http://ltt.polymtl.ca/lttng for package listing)
wget http://ltt.polymtl.ca/lttng/patch-2.6.X-lttng-0.x.xx.tar.bz2
bzip2 -cd patch-2.6.X-lttng-0.x.xx.tar.bz2 | tar xvof -


* Getting LTTng kernel sources

su -
cd /usr/src
wget http://kernel.org/pub/linux/kernel/v2.6/linux-2.6.X.tar.bz2
bzip2 -cd linux-2.6.X.tar.bz2 | tar xvof -
cd linux-2.6.X
cat /usr/src/lttng/patch-2.6.X-lttng-0.x.xx* | patch -p1
cd ..
mv linux-2.6.X linux-2.6.X-lttng-0.x.xx


* Installing a LTTng kernel

su -
cd /usr/src/linux-2.6.X-lttng-0.x.xx
make menuconfig (or make xconfig or make config)
    Select the < Help > button if you are not familiar with kernel
    configuration.
    Items preceded by [*] means they has to be built into the kernel.
    Items preceded by [M] means they has to be built as modules.
    Items preceded by [ ] means they should be removed.
  go to the "Instrumentation Support" section
    Select the following options :
    [*] Linux Trace Toolkit Instrumentation Support
    <M> or <*> Linux Trace Toolkit Tracer
        It makes no difference for the rest of the procedure whether the Tracer
        is compiled built-in or as a module.
    activate :
       [*] Align Linux Trace Toolkit Traces
       [*] Allow tracing from userspace
    your choice (see < Help >) :
       [ ] Activate Linux Trace Toolkit Heartbeat Timer
    You may or may not activate instrumentation per facility. They are all
    selected for logging by default. It can be used as a compile time filter to
    enable/disable logging of events. It is useful to discard events with a
    minimal impact on the system and especially useful for now, as the dynamic
    filter has not been implemented yet.
    Select <Exit>
  Select <Exit>
  Select <Yes>
make
make modules_install

-- on X86, X86_64
make install
reboot
Select the Linux 2.6.17-lttng-0.x.xx kernel in your boot loader.

-- on PowerPC
cp vmlinux.strip /boot/vmlinux-2.6.X-lttng-0.x.xx
cp System.map /boot/System.map-2.6.X-lttng-0.x.xx
cp .config /boot/config-2.6.X-lttng-0.x.xx
depmod -ae -F /boot/System.map-2.6.X-lttng-0.x.xx 2.6.X-lttng-0.x.xx
mkinitrd /boot/initrd.img-2.6.X-lttng-0.x.xx 2.6.X-lttng-0.x.xx
(edit /etc/yaboot.conf to add a new entry pointing to your kernel : the entry
that comes first is the default kernel)
ybin
select the right entry at the yaboot prompt (see choices : tab, select : type
the kernel name followed by enter)
Select the Linux 2.6.17-lttng-0.x.xx kernel in your boot loader.
--



* Editing the system wide configuration

You must activate relayfs and specify a mount point. This is typically done in
fstab such that it happens at boot time.

If you have never used RelayFS before, these operation would do this for you :

mkdir /mnt/relayfs
cp /etc/fstab /etc/fstab.lttng.bkp
echo "relayfs         /mnt/relayfs    relayfs rw              0       0"  >> /etc/fstab

then, rebooting or issuing the following command will activate relayfs :

mount /mnt/relayfs

You need to load the ltt-control module to be able to control tracing from user
space. This is done by issuing the command :

modprobe ltt-control

If you want to have complete information about the kernel state (including all
the process names), you need to load the ltt-statedump module. This is done by
issuing the command :

modprobe ltt-statedump

You can automate at boot time loading the ltt-control module by :

echo ltt-control >> /etc/modules
echo ltt-statedump >> /etc/modules


* Getting and installing the ltt-control package (on the traced machine)
(note : the ltt-control package contains lttd and lttctl. Although it has the
same name as the ltt-control kernel module, they are *not* the same thing.)
su -
cd /usr/src
wget http://ltt.polymtl.ca/lttng/ltt-control-0.x-xxxx2006.tar.gz
gzip -cd ltt-control-0.x-xxxx2006.tar.gz | tar xvof -
cd ltt-control-0.x-xxxx2006
(refer to README to see the development libraries that must be installed on you
system)
./configure
make
make install

* Getting and installing the ltt-usertrace package for user space tracing
See http://ltt.polymtl.ca/ > USERSPACE TRACING QUICKSTART


* Getting and installing the LTTV package (on the visualisation machine, same or
  different from the visualisation machine)

su -
cd /usr/src
wget http://ltt.polymtl.ca/packages/LinuxTraceToolkitViewer-0.x.xx-xxxx2006.tar.gz
gzip -cd LinuxTraceToolkitViewer-0.x.xx-xxxx2006.tar.gz | tar xvof -
cd LinuxTraceToolkitViewer-0.x.xx-xxxx2006
(refer to README to see the development libraries that must be installed on you
system)
./configure
make
make install




***********************************************************
** Section 3 * Using LTTng and LTTV                      **
***********************************************************

* Use graphical LTTV to control tracing and analyse traces

lttv-gui (or /usr/local/bin/lttv-gui)
  - Spot the "Tracing Control" icon : click on it
      (it's a traffic light icon)
    - enter the root password
    - click "start"
    - click "stop"
    - Yes
      * You should now see a trace

* Use text mode LTTng to control tracing

The tracing can be controlled from a terminal by using the lttctl command (as
root).

Start tracing :

lttctl -n trace -d -l /mnt/relayfs/ltt -t /tmp/trace

Stop tracing and destroy trace channels :

lttctl -n trace -R

see lttctl --help for details.


* Use text mode LTTV

Fell free to look in /usr/local/lib/lttv/plugins to see all the text and
graphical plugins available.

For example, a simple trace dump in text format is available with :

lttv -m textDump -t /tmp/trace

see lttv -m textDump --help for detailed command line options of textDump.




***********************************************************
** Section 4 * Adding new instrumentations with genevent **
***********************************************************

* Getting and installing genevent

su -
cd /usr/src
wget http://ltt.polymtl.ca/packages/genevent-0.xx.tar.gz
gzip -cd genevent-0.xx.tar.gz | tar xvof -
cd genevent-0.xx
make
make install


* Add new events to the kernel with genevent

su -
cd /usr/local/share/LinuxTraceToolkitViewer/facilities
cp process.xml yourfacility.xml
  * edit yourfacility.xml to fit your needs.
cd /tmp
/usr/local/bin/genevent /usr/local/share/LinuxTraceToolkitViewer/facilities/yourfacility.xml
cp ltt-facility-yourfacility.h ltt-facility-id-yourfacility.h \
         /usr/src/linux-2.6.17-lttng-0.x.xx8/include/linux/ltt
cp ltt-facility-loader-yourfacility.c ltt-facility-loader-yourfacility.h \
         /usr/src/linux-2.6.17-lttng-0.x.xx/ltt
  * edit the kernel file you want to instrument
    - Add #include <linux/ltt/ltt-facility-yourfacility.h> at the beginning
      of the file.
    - Add a call to the tracing functions. See their names and parameters in
      /usr/src/linux-2.6.17-lttng-0.x.xx/include/linux/ltt/ltt-facility-yourfacility.h
    
* Add new events to userspace programs with genevent
See http://ltt.polymtl.ca/ > USERSPACE TRACING QUICKSTART




